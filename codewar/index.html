<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeWar Competition Platform</title>
  <link rel="stylesheet" href="css/codewar.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>CodeWar Competition</h1>
      <p class="subtitle">TechnoMeet 2K26</p>
    </div>

    <div id="countdown-section" class="timer-container">
      <h2>Competition Starts In</h2>
      <div id="countdown" class="countdown-display">Loading...</div>
      <p id="countdown-message" class="text-center"></p>
    </div>

    <div id="auth-section" class="form-container" style="display: none;">
      <h2 class="text-center">Enter Registration Code</h2>
      <form id="auth-form" onsubmit="handleAuth(event)">
        <div class="form-group">
          <label for="code">Registration Code</label>
          <input type="text" id="code" name="code" placeholder="CODE-XXXX" required autocomplete="off">
        </div>
        <button type="submit" class="btn" style="width: 100%;" id="auth-submit-btn">Enter Competition</button>
      </form>
      <p id="auth-error" style="color: var(--accent-red); margin-top: 15px; display: none;"></p>
    </div>

    <div id="rounds-section" style="display: none;">
      <div class="results-container">
        <h2 class="text-center">Competition Rounds</h2>
        <p id="round-status" class="text-center" style="color: var(--text-secondary); margin-bottom: 20px;"></p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
          <!-- MCQ Round Card -->
          <div class="score-card" id="mcq-card">
            <h3>Round 1: MCQ Quiz</h3>
            <p>20 questions, 30 minutes</p>
            <div id="mcq-score" style="margin: 10px 0; color: var(--accent-green); display: none;"></div>
            <button id="mcq-btn" class="btn mt-20" onclick="navigateToRound('mcq')">Start MCQ Round</button>
          </div>
          
          <!-- Debug Round Card -->
          <div class="score-card" id="debug-card">
            <h3>Round 2: Debug Code</h3>
            <p>Debug faulty programs, 45 minutes</p>
            <div id="debug-score" style="margin: 10px 0; color: var(--accent-green); display: none;"></div>
            <button id="debug-btn" class="btn mt-20" onclick="navigateToRound('debug')" disabled>Start Debug Round</button>
          </div>
          
          <!-- PS Round Card -->
          <div class="score-card" id="ps-card">
            <h3>Round 3: Problem Statement</h3>
            <p>Solve coding problems, 60 minutes</p>
            <div id="ps-score" style="margin: 10px 0; color: var(--accent-green); display: none;"></div>
            <button id="ps-btn" class="btn mt-20" onclick="navigateToRound('ps')" disabled>Start PS Round</button>
          </div>
        </div>
        
        <!-- Results Button (shown when completed) -->
        <div id="results-section" style="text-align: center; margin-top: 30px; display: none;">
          <button class="btn btn-success" onclick="window.location.href='results.html'" style="font-size: 1.2em; padding: 15px 40px;">
            üèÜ View Final Results
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/utils.js?v=3"></script>
  <script src="js/storage.js?v=3"></script>
  <script src="js/auth.js?v=3"></script>
  <script src="js/timer.js?v=3"></script>
  <script>
    let countdownTimer = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initializePage);

    function initializePage() {
      // Verify storage is working
      if (!StorageManager.verifyStorageIntegrity()) {
        document.body.innerHTML = `
          <div style="padding: 50px; text-align: center; color: white;">
            <h1>Storage Error</h1>
            <p>Browser storage is not working. Please enable cookies and reload the page.</p>
          </div>
        `;
        return;
      }
      
      // FIX: Clear auth error when user starts typing
      // NON-BLOCKING: Inline error handling instead of alerts
      const codeInput = document.getElementById('code');
      if (codeInput) {
        codeInput.addEventListener('input', () => {
          const errorEl = document.getElementById('auth-error');
          if (errorEl) {
            errorEl.style.display = 'none';
          }
        });
      }
      
      // Check authentication
      if (checkAuthentication()) {
        const currentRound = StorageManager.getCurrentRound();
        if (currentRound === 'completed') {
          // Competition finished - show results
          window.location.href = 'results.html';
        } else {
          showRoundsSection();
        }
      } else {
        // Check if exam can start
        if (canStartExam()) {
          showAuthSection();
        } else {
          startCountdown();
        }
      }
    }

    function startCountdown() {
      countdownTimer = new CountdownTimer((countdown) => {
        const countdownEl = document.getElementById('countdown');
        const messageEl = document.getElementById('countdown-message');
        
        if (countdown.days > 0 || countdown.hours > 0 || countdown.minutes > 0 || countdown.seconds > 0) {
          countdownEl.textContent = countdown.formatted;
          messageEl.textContent = 'Please wait for the competition to start';
        } else {
          countdownEl.textContent = 'Competition Started!';
          messageEl.textContent = 'You can now enter your registration code';
          countdownTimer.stop();
          showAuthSection();
        }
      });
      countdownTimer.start();
    }

    function showAuthSection() {
      document.getElementById('countdown-section').style.display = 'none';
      document.getElementById('auth-section').style.display = 'block';
      document.getElementById('rounds-section').style.display = 'none';
    }

    function showRoundsSection() {
      document.getElementById('countdown-section').style.display = 'none';
      document.getElementById('auth-section').style.display = 'none';
      document.getElementById('rounds-section').style.display = 'block';
      
      updateRoundStatus();
    }

    /**
     * FIX: Improved round state validation and UI update
     */
    function updateRoundStatus() {
      const currentRound = StorageManager.getCurrentRound();
      const mcqScore = StorageManager.getMCQScore();
      const debugScore = StorageManager.getDebugScore();
      const psScore = StorageManager.getPSScore();
      
      // Update status message
      const statusEl = document.getElementById('round-status');
      
      // MCQ button and score
      const mcqBtn = document.getElementById('mcq-btn');
      const mcqScoreEl = document.getElementById('mcq-score');
      
      if (mcqScore) {
        mcqScoreEl.textContent = `Score: ${mcqScore.score}/${mcqScore.totalQuestions || 20} (${mcqScore.percentage}%)`;
        mcqScoreEl.style.display = 'block';
        mcqBtn.textContent = 'MCQ Completed ‚úì';
        mcqBtn.disabled = true;
        mcqBtn.classList.add('btn-success');
      } else {
        mcqBtn.disabled = false;
        mcqBtn.textContent = currentRound === 'mcq' ? 'Continue MCQ Round' : 'Start MCQ Round';
      }
      
      // Debug button and score
      const debugBtn = document.getElementById('debug-btn');
      const debugScoreEl = document.getElementById('debug-score');
      
      if (debugScore) {
        debugScoreEl.textContent = `Score: ${debugScore.score}/5 (${debugScore.percentage}%)`;
        debugScoreEl.style.display = 'block';
        debugBtn.textContent = 'Debug Completed ‚úì';
        debugBtn.disabled = true;
        debugBtn.classList.add('btn-success');
      } else if (mcqScore || currentRound === 'debug' || currentRound === 'ps' || currentRound === 'completed') {
        debugBtn.disabled = false;
        debugBtn.textContent = currentRound === 'debug' ? 'Continue Debug Round' : 'Start Debug Round';
      } else {
        debugBtn.disabled = true;
        debugBtn.textContent = 'Complete MCQ first';
      }
      
      // PS button and score
      const psBtn = document.getElementById('ps-btn');
      const psScoreEl = document.getElementById('ps-score');
      
      if (psScore !== null && psScore !== undefined) {
        psScoreEl.textContent = `Score: ${psScore}%`;
        psScoreEl.style.display = 'block';
        psBtn.textContent = 'PS Completed ‚úì';
        psBtn.disabled = true;
        psBtn.classList.add('btn-success');
      } else if (debugScore || currentRound === 'ps' || currentRound === 'completed') {
        psBtn.disabled = false;
        psBtn.textContent = currentRound === 'ps' ? 'Continue PS Round' : 'Start PS Round';
      } else {
        psBtn.disabled = true;
        psBtn.textContent = 'Complete Debug first';
      }
      
      // Show results button if competition is completed
      if (currentRound === 'completed' || (mcqScore && debugScore && psScore !== null)) {
        document.getElementById('results-section').style.display = 'block';
        statusEl.textContent = 'üéâ Competition completed! View your results below.';
        statusEl.style.color = 'var(--accent-green)';
      } else {
        document.getElementById('results-section').style.display = 'none';
        
        // Set appropriate status message
        if (currentRound === 'not_started' || !currentRound) {
          statusEl.textContent = 'Start with Round 1: MCQ Quiz';
        } else if (currentRound === 'mcq') {
          statusEl.textContent = 'Continue Round 1: MCQ Quiz';
        } else if (currentRound === 'debug') {
          statusEl.textContent = 'Continue Round 2: Debug Code';
        } else if (currentRound === 'ps') {
          statusEl.textContent = 'Continue Round 3: Problem Statement';
        }
      }
    }

    function handleAuth(event) {
      event.preventDefault();
      const code = document.getElementById('code').value.trim();
      const errorEl = document.getElementById('auth-error');
      const submitBtn = document.getElementById('auth-submit-btn');
      
      // FIX: Show inline error for empty submission
      // NON-BLOCKING: Uses inline DOM error instead of alert()
      if (!code || code.length === 0) {
        errorEl.textContent = 'Please enter a registration code.';
        errorEl.style.display = 'block';
        return;  // Don't proceed with empty code
      }
      
      // Disable button during auth
      submitBtn.disabled = true;
      submitBtn.textContent = 'Validating...';
      errorEl.style.display = 'none';
      
      // Use async authentication
      authenticateAsync(code).then(result => {
        if (result.success) {
          showRoundsSection();
        } else {
          errorEl.textContent = result.message;
          errorEl.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enter Competition';
        }
      }).catch(error => {
        console.error('Auth error:', error);
        errorEl.textContent = 'An error occurred. Please try again.';
        errorEl.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enter Competition';
      });
    }

    /**
     * FIX: Strict round navigation with proper state validation
     * NON-BLOCKING: All alerts replaced with showToast/showAlert
     * to prevent focus theft and timer desync
     */
    function navigateToRound(round) {
      const currentRound = StorageManager.getCurrentRound();
      const mcqScore = StorageManager.getMCQScore();
      const debugScore = StorageManager.getDebugScore();
      
      if (round === 'mcq') {
        // MCQ is the first round
        // Allow if: not_started, mcq, or no score yet
        if (!mcqScore) {
          if (currentRound !== 'mcq') {
            StorageManager.setCurrentRound('mcq');
          }
          window.location.href = 'mcq.html';
        } else {
          // NON-BLOCKING: showToast for informational messages
          showToast('MCQ round already completed.', 'info');
        }
      } 
      else if (round === 'debug') {
        // Debug requires MCQ completion
        if (!mcqScore) {
          // NON-BLOCKING: showAlert doesn't steal focus
          showAlert('Please complete the MCQ round first', 'Round Locked', 'warning');
          return;
        }
        if (!debugScore) {
          if (currentRound !== 'debug') {
            StorageManager.setCurrentRound('debug');
          }
          window.location.href = 'debug.html';
        } else {
          // NON-BLOCKING: showToast for informational messages
          showToast('Debug round already completed.', 'info');
        }
      } 
      else if (round === 'ps') {
        // PS requires Debug completion
        if (!debugScore) {
          // NON-BLOCKING: showAlert doesn't steal focus
          showAlert('Please complete the Debug round first', 'Round Locked', 'warning');
          return;
        }
        if (StorageManager.getPSScore() === null || StorageManager.getPSScore() === undefined) {
          if (currentRound !== 'ps') {
            StorageManager.setCurrentRound('ps');
          }
          window.location.href = 'ps.html';
        } else {
          // NON-BLOCKING: showToast for informational messages
          showToast('Problem Statement round already completed.', 'info');
        }
      }
    }
  </script>
</body>
</html>
