<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Results - CodeWar</title>
  <link rel="stylesheet" href="css/codewar.css">
  <style>
    /* Rules widget: always top-right, panel only on hover */
    .rules-widget {
      position: fixed !important;
      top: 12px !important;
      left: 12px !important;
      z-index: 9999 !important;
    }
    .rules-widget-panel {
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }
    .rules-widget:hover .rules-widget-panel {
      opacity: 1 !important;
      visibility: visible !important;
      pointer-events: auto !important;
    }
    .score-breakdown-detail {
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-top: 10px;
    }
    .score-breakdown-detail div {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
    }
    .penalty-value {
      color: var(--accent-red);
    }
    .bonus-value {
      color: var(--accent-green);
    }
    .eliminated-badge {
      background: var(--accent-red);
      color: white;
      padding: 5px 15px;
      border-radius: 5px;
      font-size: 0.8em;
      font-weight: bold;
      display: inline-block;
      margin-top: 10px;
    }
    .not-attempted {
      opacity: 0.5;
    }
    .total-score-display {
      font-size: 3em;
      font-weight: bold;
      color: var(--accent-cyan);
      margin: 10px 0;
    }
    .time-display {
      color: var(--accent-yellow);
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="rules-widget" data-round="results">
    <span class="rules-widget-icon" aria-label="Rules">ðŸ“‹</span>
    <div class="rules-widget-panel">
      <h4>General rules</h4>
      <ul>
        <li>Rounds: MCQ â†’ Debug â†’ PS. Scores and time are final after submission.</li>
      </ul>
      <div class="rules-round-section">
        <h4>Results</h4>
        <ul>
          <li>Your result file is auto-downloaded; submit it to the invigilator if required.</li>
          <li>You can download again with the button below.</li>
        </ul>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="header">
      <h1>Competition Results</h1>
      <p class="subtitle">CodeWar TechnoMeet 2K26</p>
    </div>

    <!-- Elimination Status Banner -->
    <div id="elimination-banner" style="display: none; background: linear-gradient(135deg, #dc354522, #c8233322); border: 2px solid var(--accent-red); border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">
      <h3 style="color: var(--accent-red); margin-bottom: 10px;">Competition Ended Early</h3>
      <p id="elimination-reason" style="color: var(--text-secondary);"></p>
    </div>

    <div class="results-container">
      <div class="results-summary">
        <p style="color: var(--text-secondary);">Total Score</p>
        <div class="total-score-display" id="total-score">-</div>
        <p style="color: var(--text-secondary);">points</p>
        <p class="time-display" id="total-time">Total Time: -</p>
      </div>

      <div class="score-breakdown">
        <!-- MCQ Card -->
        <div class="score-card" id="mcq-card">
          <h3>Round 1: MCQ</h3>
          <div class="score-value" id="mcq-total">-</div>
          <p id="mcq-correct" style="color: var(--text-secondary);">-</p>
          <div class="score-breakdown-detail" id="mcq-breakdown"></div>
        </div>
        
        <!-- Debug Card -->
        <div class="score-card" id="debug-card">
          <h3>Round 2: Debug</h3>
          <div class="score-value" id="debug-total">-</div>
          <p id="debug-correct" style="color: var(--text-secondary);">-</p>
          <div class="score-breakdown-detail" id="debug-breakdown"></div>
        </div>
        
        <!-- PS Card -->
        <div class="score-card" id="ps-card">
          <h3>Round 3: Problem Solving</h3>
          <div class="score-value" id="ps-total">-</div>
          <p id="ps-correct" style="color: var(--text-secondary);">-</p>
          <div class="score-breakdown-detail" id="ps-breakdown"></div>
        </div>
      </div>

      <div class="results-container" style="margin-top: 30px;">
        <h3>Competition Statistics</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
          <div class="score-card">
            <h4>Warnings</h4>
            <div style="font-size: 2em; color: var(--accent-yellow);" id="warnings-count">0</div>
          </div>
          <div class="score-card">
            <h4>Tab Switches</h4>
            <div style="font-size: 2em; color: var(--accent-yellow);" id="tab-switches-count">0</div>
          </div>
          <div class="score-card">
            <h4>Network Activity</h4>
            <div style="font-size: 2em;" id="network-count">0</div>
            <p style="font-size: 0.7em; color: var(--text-secondary);">External requests</p>
          </div>
          <div class="score-card">
            <h4>Total Penalties</h4>
            <div style="font-size: 2em; color: var(--accent-red);" id="total-penalties">0</div>
          </div>
          <div class="score-card">
            <h4>Registration</h4>
            <div style="font-size: 1em; color: var(--accent-cyan);" id="reg-code">-</div>
          </div>
        </div>
      </div>

      <div style="text-align: center; margin-top: 40px;">
        <p style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 12px;">Your result file was auto-downloaded. Submit it to the invigilator or keep a copy.</p>
        <button class="btn" onclick="downloadResults()">Download Results Again</button>
        <button class="btn btn-secondary" onclick="window.location.href='index.html'">Back to Home</button>
      </div>
    </div>
  </div>

  <script src="js/logger.js?v=1"></script>
  <script src="js/utils.js?v=3"></script>
  <script src="js/storage.js?v=4"></script>
  <script src="js/auth.js?v=3"></script>
  <script src="js/timer.js?v=3"></script>
  <script src="js/scoring.js?v=1"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAuthentication()) {
        window.location.href = 'index.html';
        return;
      }
      displayResults();
      // Auto-download result file once when user lands on results (offline lab collection)
      autoDownloadResultsOnce();
    });

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}m ${secs}s`;
    }

    function displayResults() {
      // Get detailed score data
      const mcqData = StorageManager.getMCQScoreData();
      const debugData = StorageManager.getDebugScoreData();
      const psData = StorageManager.getPSScoreData();
      
      // Legacy fallbacks
      const mcqLegacy = StorageManager.getMCQScore();
      const debugLegacy = StorageManager.getDebugScore();
      const psLegacy = StorageManager.getPSScore();
      
      let totalScore = 0;
      let totalTime = 0;
      let totalPenalties = 0;

      // Check elimination status
      const isEliminated = StorageManager.isEliminated();
      const eliminatedRound = StorageManager.getEliminatedRound();
      
      if (isEliminated) {
        document.getElementById('elimination-banner').style.display = 'block';
        const roundNames = { mcq: 'MCQ', debug: 'Debug', ps: 'Problem Solving' };
        document.getElementById('elimination-reason').textContent = 
          `You were eliminated after the ${roundNames[eliminatedRound] || eliminatedRound} round due to not meeting the minimum score threshold.`;
      }

      // Display MCQ Results
      if (mcqData) {
        totalScore += mcqData.totalScore || 0;
        totalTime += mcqData.timeUsed || 0;
        totalPenalties += Math.abs(mcqData.penalties || 0);
        
        document.getElementById('mcq-total').textContent = `${mcqData.totalScore.toFixed(1)} pts`;
        document.getElementById('mcq-correct').textContent = 
          `${mcqData.details.correctAnswers}/${ScoringSystem.MAX_QUESTIONS.mcq} correct`;
        
        document.getElementById('mcq-breakdown').innerHTML = `
          <div><span>Base:</span><span>+${mcqData.basePoints}</span></div>
          <div><span>Time Bonus:</span><span class="bonus-value">+${mcqData.timeBonus.toFixed(1)}</span></div>
          ${mcqData.penalties < 0 ? `<div><span>Penalties:</span><span class="penalty-value">${mcqData.penalties}</span></div>` : ''}
          <div><span>Time Used:</span><span>${formatTime(mcqData.timeUsed)}</span></div>
        `;
      } else if (mcqLegacy) {
        document.getElementById('mcq-total').textContent = `${mcqLegacy.score} pts`;
        document.getElementById('mcq-correct').textContent = `${mcqLegacy.percentage}%`;
        totalScore += mcqLegacy.score || 0;
      } else {
        document.getElementById('mcq-card').classList.add('not-attempted');
        document.getElementById('mcq-total').textContent = 'Not Attempted';
        if (eliminatedRound && ['mcq'].includes(eliminatedRound)) {
          document.getElementById('mcq-card').innerHTML += '<span class="eliminated-badge">ELIMINATED</span>';
        }
      }

      // Display Debug Results
      if (debugData) {
        totalScore += debugData.totalScore || 0;
        totalTime += debugData.timeUsed || 0;
        totalPenalties += Math.abs(debugData.penalties || 0);
        
        document.getElementById('debug-total').textContent = `${debugData.totalScore.toFixed(1)} pts`;
        document.getElementById('debug-correct').textContent = 
          `${debugData.details.correctAnswers}/${ScoringSystem.MAX_QUESTIONS.debug} correct`;
        
        document.getElementById('debug-breakdown').innerHTML = `
          <div><span>Base:</span><span>+${debugData.basePoints}</span></div>
          <div><span>Time Bonus:</span><span class="bonus-value">+${debugData.timeBonus.toFixed(1)}</span></div>
          ${debugData.penalties < 0 ? `<div><span>Penalties:</span><span class="penalty-value">${debugData.penalties}</span></div>` : ''}
          <div><span>Time Used:</span><span>${formatTime(debugData.timeUsed)}</span></div>
        `;
      } else if (debugLegacy) {
        document.getElementById('debug-total').textContent = `${debugLegacy.score * 5} pts`;
        document.getElementById('debug-correct').textContent = `${debugLegacy.percentage}%`;
        totalScore += (debugLegacy.score || 0) * 5;
      } else {
        document.getElementById('debug-card').classList.add('not-attempted');
        document.getElementById('debug-total').textContent = 'Not Attempted';
        if (eliminatedRound && ['mcq', 'debug'].includes(eliminatedRound)) {
          if (eliminatedRound === 'debug') {
            document.getElementById('debug-card').innerHTML += '<span class="eliminated-badge">ELIMINATED</span>';
          }
        }
      }

      // Display PS Results
      if (psData) {
        totalScore += psData.totalScore || 0;
        totalTime += psData.timeUsed || 0;
        totalPenalties += Math.abs(psData.penalties || 0);
        
        document.getElementById('ps-total').textContent = `${psData.totalScore.toFixed(1)} pts`;
        document.getElementById('ps-correct').textContent = 
          `${psData.details.correctAnswers}/${ScoringSystem.MAX_QUESTIONS.ps} correct`;
        
        document.getElementById('ps-breakdown').innerHTML = `
          <div><span>Base:</span><span>+${psData.basePoints}</span></div>
          <div><span>Time Bonus:</span><span class="bonus-value">+${psData.timeBonus.toFixed(1)}</span></div>
          ${psData.penalties < 0 ? `<div><span>Penalties:</span><span class="penalty-value">${psData.penalties}</span></div>` : ''}
          <div><span>Time Used:</span><span>${formatTime(psData.timeUsed)}</span></div>
        `;
      } else if (psLegacy !== null) {
        document.getElementById('ps-total').textContent = `${psLegacy}%`;
        document.getElementById('ps-correct').textContent = 'Test cases passed';
      } else {
        document.getElementById('ps-card').classList.add('not-attempted');
        document.getElementById('ps-total').textContent = 'Not Attempted';
      }

      // Display totals
      document.getElementById('total-score').textContent = totalScore.toFixed(1);
      document.getElementById('total-time').textContent = `Total Time: ${formatTime(totalTime)}`;
      document.getElementById('total-penalties').textContent = totalPenalties > 0 ? `-${totalPenalties}` : '0';

      // Display statistics
      document.getElementById('warnings-count').textContent = StorageManager.getWarnings();
      document.getElementById('tab-switches-count').textContent = StorageManager.getTabSwitches();
      document.getElementById('reg-code').textContent = StorageManager.getRegistrationCode() || 'N/A';
      
      const networkRequests = StorageManager.getNetworkRequests();
      const networkEl = document.getElementById('network-count');
      networkEl.textContent = networkRequests;
      if (networkRequests === 0) {
        networkEl.style.color = 'var(--accent-green)';
      } else if (networkRequests <= 2) {
        networkEl.style.color = 'var(--accent-yellow)';
      } else {
        networkEl.style.color = 'var(--accent-red)';
      }
    }

    function buildResultsPayload() {
      const results = {
        registrationCode: StorageManager.getRegistrationCode(),
        totalScore: 0,
        totalTimeUsed: 0,
        rounds: {
          mcq: StorageManager.getMCQScoreData() || StorageManager.getMCQScore(),
          debug: StorageManager.getDebugScoreData() || StorageManager.getDebugScore(),
          ps: StorageManager.getPSScoreData() || { score: StorageManager.getPSScore() }
        },
        statistics: {
          warnings: StorageManager.getWarnings(),
          tabSwitches: StorageManager.getTabSwitches(),
          networkRequests: StorageManager.getNetworkRequests()
        },
        elimination: {
          eliminated: StorageManager.isEliminated(),
          round: StorageManager.getEliminatedRound()
        },
        timestamp: new Date().toISOString()
      };
      if (results.rounds.mcq && (results.rounds.mcq.totalScore != null || results.rounds.mcq.score != null)) {
        results.totalScore += results.rounds.mcq.totalScore || results.rounds.mcq.score || 0;
        results.totalTimeUsed += results.rounds.mcq.timeUsed || 0;
      }
      if (results.rounds.debug && (results.rounds.debug.totalScore != null || results.rounds.debug.score != null)) {
        results.totalScore += results.rounds.debug.totalScore || results.rounds.debug.score || 0;
        results.totalTimeUsed += results.rounds.debug.timeUsed || 0;
      }
      if (results.rounds.ps && (results.rounds.ps.totalScore != null || results.rounds.ps.score != null)) {
        results.totalScore += results.rounds.ps.totalScore || results.rounds.ps.score || 0;
        results.totalTimeUsed += results.rounds.ps.timeUsed || 0;
      }
      return results;
    }

    function getResultsFileName() {
      const code = (StorageManager.getRegistrationCode() || 'unknown').replace(/[^a-zA-Z0-9-_]/g, '_');
      const ts = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      return `codewar-results-${code}-${ts}.json`;
    }

    function downloadResults() {
      const results = buildResultsPayload();
      const dataStr = JSON.stringify(results, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = getResultsFileName();
      link.click();
      URL.revokeObjectURL(url);
    }

    function autoDownloadResultsOnce() {
      if (typeof StorageManager === 'undefined') return;
      const payload = buildResultsPayload();
      const hasData = payload.totalScore > 0 || (payload.rounds.mcq && (payload.rounds.mcq.totalScore != null || payload.rounds.mcq.score != null)) ||
        (payload.rounds.debug && (payload.rounds.debug.totalScore != null || payload.rounds.debug.score != null)) ||
        (payload.rounds.ps && (payload.rounds.ps.totalScore != null || payload.rounds.ps.score != null));
      if (!hasData) return;
      try {
        if (sessionStorage.getItem('codewar_results_auto_downloaded')) return;
        sessionStorage.setItem('codewar_results_auto_downloaded', '1');
        const dataStr = JSON.stringify(payload, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = getResultsFileName();
        link.click();
        URL.revokeObjectURL(url);
      } catch (e) {
        console.warn('[Results] Auto-download failed:', e);
      }
    }
  </script>
</body>
</html>
